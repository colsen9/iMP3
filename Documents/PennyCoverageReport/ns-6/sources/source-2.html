


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ListController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.imp3.Backend.list</a>
</div>

<h1>Coverage Summary for Class: ListController (com.imp3.Backend.list)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ListController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    17.6%
  </span>
  <span class="absValue">
    (3/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    4%
  </span>
  <span class="absValue">
    (3/75)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.imp3.Backend.list;
&nbsp;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.JsonProcessingException;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import com.imp3.Backend.common.AbstractController;
&nbsp;import com.imp3.Backend.common.SpotifyImportService;
&nbsp;import com.imp3.Backend.music.Album;
&nbsp;import com.imp3.Backend.music.Track;
&nbsp;import com.imp3.Backend.music.TrackDTO;
&nbsp;import com.imp3.Backend.notification.NotificationService;
&nbsp;import com.imp3.Backend.user.User;
&nbsp;import com.imp3.Backend.user.UserRepository;
&nbsp;import jakarta.servlet.http.HttpSession;
&nbsp;import jakarta.transaction.Transactional;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;import org.springframework.web.server.ResponseStatusException;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.Base64;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@RestController
<b class="fc">&nbsp;@RequestMapping(&quot;/lists&quot;)</b>
&nbsp;public class ListController extends AbstractController {
&nbsp;
&nbsp;    @Autowired
&nbsp;    ListRepository listrepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    UserRepository userrepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    NotificationService notificationservice;
&nbsp;
&nbsp;    @Autowired
&nbsp;    ListSongRepository listsongrepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    ListAlbumRepository listalbumrepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ListService listservice;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private SpotifyImportService spotifyimportservice;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ObjectMapper objectmapper;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * CREATE (POST) - Creates a new list for a given user
<b class="nc">&nbsp;     * @param body (JSON) of ListRequest type</b>
&nbsp;     * @param session HttpSession containing &quot;uid&quot;
&nbsp;     * @return UserList that the user just created
<b class="nc">&nbsp;     */</b>
<b class="nc">&nbsp;    @PostMapping</b>
&nbsp;    @ResponseStatus(HttpStatus.CREATED)
&nbsp;    public UserList createUserList(@RequestBody ListRequest body, HttpSession session){
<b class="nc">&nbsp;        Integer uid = getSessionUid(session);</b>
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;        //verify owner of list (user)</b>
<b class="nc">&nbsp;        User owner = userrepository.findById(uid).orElseThrow(</b>
&nbsp;                ()-&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;User not found&quot;));
<b class="nc">&nbsp;</b>
&nbsp;        //create new list
<b class="nc">&nbsp;        UserList list = new UserList();</b>
&nbsp;        list.setOwner(owner);
<b class="nc">&nbsp;        list.setTitle(body.getTitle());</b>
&nbsp;        list.setDescription(body.getDescription());
<b class="nc">&nbsp;        //list.setCoverImage(body.getCoverImage());</b>
&nbsp;        list.setPrivacy(body.getPrivacy());
&nbsp;
&nbsp;        UserList saved = listrepository.save(list);
&nbsp;
&nbsp;        notificationservice.notifyFollowersOfNewList(saved);
&nbsp;
&nbsp;        return saved;
&nbsp;    }
&nbsp;
&nbsp;    /**
<b class="nc">&nbsp;     * READ (GET) - Get one UserList</b>
&nbsp;     * @param listId id of the list
<b class="nc">&nbsp;     * @param session HttpSession containing &quot;uid&quot;</b>
<b class="nc">&nbsp;     * @return list matching &quot;listId&quot;</b>
&nbsp;     */
&nbsp;    @GetMapping(&quot;/{listId}&quot;)
<b class="nc">&nbsp;    public UserList getUserList(@PathVariable Integer listId, HttpSession session){</b>
<b class="nc">&nbsp;        Integer uid = getSessionUid(session);</b>
&nbsp;
<b class="nc">&nbsp;        UserList list = listrepository.findById(listId).orElseThrow(</b>
&nbsp;                ()-&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;List not found&quot;));
&nbsp;
&nbsp;        //403 if user accessing list is not the owner and the list is private
&nbsp;        if(!list.getOwner().getId().equals(uid) &amp;&amp; (list.getPrivacy() == UserList.Privacy.PRIVATE)){
&nbsp;            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;You do not have access to this list&quot;);
&nbsp;        }
&nbsp;        return list;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * UPDATE (PUT) - Updates a user&#39;s list
<b class="nc">&nbsp;     * @param listId of the list to update</b>
&nbsp;     * @param body (JSON) of ListRequest type
&nbsp;     * @return list that was just updated
<b class="nc">&nbsp;     */</b>
<b class="nc">&nbsp;    @PutMapping(&quot;/{listId}&quot;)</b>
&nbsp;    public UserList updateUserList(@PathVariable Integer listId, @RequestBody ListRequest body, HttpSession session){
<b class="nc">&nbsp;        //validate session user</b>
<b class="nc">&nbsp;        Integer uid = getSessionUid(session);</b>
&nbsp;
<b class="nc">&nbsp;        //verify owner of list (user)</b>
<b class="nc">&nbsp;        User owner = userrepository.findById(uid).orElseThrow(</b>
&nbsp;                ()-&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;User not found&quot;));
&nbsp;
&nbsp;        UserList list = listrepository.findById(listId).orElseThrow(
<b class="nc">&nbsp;                ()-&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;List not found&quot;));</b>
<b class="nc">&nbsp;</b>
&nbsp;        if(!list.getOwner().getId().equals(uid)){
<b class="nc">&nbsp;            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Not your list&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        //decide which field is updated
<b class="nc">&nbsp;        if(body.getTitle() != null){</b>
<b class="nc">&nbsp;            list.setTitle(body.getTitle());</b>
&nbsp;        }
<b class="nc">&nbsp;        if(body.getDescription() != null){</b>
&nbsp;            list.setDescription(body.getDescription());
&nbsp;        }
<b class="nc">&nbsp;        //picture handling</b>
&nbsp;        if(body.getCoverImage() != null){
<b class="nc">&nbsp;            String pictureBase64 = String.valueOf(body.getCoverImage());</b>
&nbsp;
<b class="nc">&nbsp;            if(pictureBase64 != null &amp;&amp; !pictureBase64.isBlank()){</b>
<b class="nc">&nbsp;                byte[] bytes;</b>
&nbsp;                try {
<b class="nc">&nbsp;                    bytes = Base64.getDecoder().decode(pictureBase64);</b>
&nbsp;                } catch(IllegalArgumentException e){
&nbsp;                    throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Invalid picture data (not base64)&quot;);
&nbsp;                }
&nbsp;                if(bytes.length &gt; 5_000_000){
<b class="nc">&nbsp;                    throw new ResponseStatusException(HttpStatus.PAYLOAD_TOO_LARGE, &quot;Cover image is too large&quot;);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;                list.setCoverImage(bytes);
&nbsp;            }
&nbsp;            //IF NULL/BLANK, DO NOTHING, KEEP EXISTING PICTURE
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        if(body.getPrivacy() != null){
<b class="nc">&nbsp;            list.setPrivacy(body.getPrivacy());</b>
&nbsp;        }
&nbsp;
&nbsp;        //updated at
&nbsp;        list.setUpdatedAt(LocalDateTime.now());
&nbsp;
&nbsp;        //saves new list in repo, and returns newly updated list
&nbsp;        return listrepository.save(list);
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * DELETE (DELETE) - Deletes a user&#39;s list
<b class="nc">&nbsp;     * @param listId id of the list to delete</b>
<b class="nc">&nbsp;     * @param session HttpSession containing &quot;uid&quot;</b>
&nbsp;     */
&nbsp;    @Transactional
<b class="nc">&nbsp;    @DeleteMapping(&quot;/{listId}&quot;)</b>
<b class="nc">&nbsp;    @ResponseStatus(HttpStatus.NO_CONTENT)</b>
<b class="nc">&nbsp;    public void deleteUserList(@PathVariable Integer listId, HttpSession session){</b>
<b class="nc">&nbsp;</b>
&nbsp;        UserList list = listrepository.findById(listId).orElseThrow(
&nbsp;                ()-&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;List not found&quot;));
<b class="nc">&nbsp;</b>
&nbsp;        // users can only edit their own lists, unless they are administrators
&nbsp;        Integer userId = getSessionUid(session);
&nbsp;        String userType = (String)session.getAttribute(&quot;type&quot;);
&nbsp;        if (!list.getOwner().getId().equals(userId) &amp;&amp; !userType.equals(&quot;admin&quot;)) {
&nbsp;            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Not your list&quot;);
&nbsp;        }
&nbsp;
&nbsp;        listsongrepository.deleteAllByList_ListId(listId);
&nbsp;        listalbumrepository.deleteAllByList_ListId(listId);
<b class="nc">&nbsp;</b>
&nbsp;        listrepository.delete(list);
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * LIST (GET) - Get all User&#39;s lists (private and public)
&nbsp;     * @param session HttpSession containing &quot;uid&quot;
&nbsp;     * @return list of all user&#39;s lists
&nbsp;     */
&nbsp;    @GetMapping
&nbsp;    public List&lt;UserList&gt; getMyLists(HttpSession session){
&nbsp;        Integer uid = getSessionUid(session);
<b class="nc">&nbsp;</b>
&nbsp;        return listrepository.findAllByOwner_Id(uid);
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * LIST (GET) - Get all User&#39;s list (public only)
&nbsp;     * @param ownerId of user&#39;s lists we want to view
&nbsp;     * @return list of all user&#39;s public lists
&nbsp;     */
&nbsp;    @GetMapping(&quot;/user/{ownerId}/public&quot;)
&nbsp;    public List&lt;UserList&gt; getUserPublicLists(@PathVariable Integer ownerId){
&nbsp;        return listrepository.findAllByOwner_IdAndPrivacy(ownerId, UserList.Privacy.PUBLIC);
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * CREATE (POST) - Adds a song to a user&#39;s list
<b class="nc">&nbsp;     * @param listId id of the target list</b>
&nbsp;     * @param songId id of the song to add
&nbsp;     * @param body if track is from Spotify
<b class="nc">&nbsp;     * @param session HttpSession containing &quot;uid&quot;</b>
&nbsp;     * @return a Map containing the operation status and confirmation details
<b class="nc">&nbsp;     */</b>
<b class="nc">&nbsp;    @PostMapping(&quot;/{listId}/songs/{songId}&quot;)</b>
<b class="nc">&nbsp;    public Map&lt;String, Object&gt; addSong(@PathVariable Integer listId,</b>
&nbsp;                                       @PathVariable Integer songId,
<b class="nc">&nbsp;                                       @RequestBody(required = false) Map&lt;String, String&gt; body,</b>
&nbsp;                                       HttpSession session){
&nbsp;        Integer uid = getSessionUid(session);
&nbsp;
<b class="nc">&nbsp;        //if Spotify data provided, create/get track first</b>
<b class="nc">&nbsp;        if(body != null &amp;&amp; body.get(&quot;spotifyData&quot;) != null){</b>
&nbsp;            try {
&nbsp;                JsonNode spotifyJson = objectmapper.readTree(body.get(&quot;spotifyData&quot;));
&nbsp;                Track track = spotifyimportservice.getOrCreateTrack(spotifyJson);
&nbsp;                songId = track.getId();
&nbsp;            } catch (JsonProcessingException e){
&nbsp;                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Invalid Spotify data&quot;);
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        listservice.addSong(listId, uid, songId);
&nbsp;        return Map.of(&quot;status&quot;, 200, &quot;message&quot;, &quot;Song added&quot;, &quot;listId&quot;, listId, &quot;songId&quot;, songId);
<b class="fc">&nbsp;    }</b>
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;    /**</b>
&nbsp;     * DELETE (DELETE) - Deletes a song from a user&#39;s list
&nbsp;     * @param listId id of the target list
&nbsp;     * @param songId id of the song to remove
&nbsp;     * @param session HttpSession containing &quot;uid&quot;
&nbsp;     * @return a Map containing the operation status and confirmation details
&nbsp;     */
&nbsp;    @DeleteMapping(&quot;/{listId}/songs/{songId}&quot;)
&nbsp;    public Map&lt;String, Object&gt; removeSong(@PathVariable Integer listId, @PathVariable Integer songId, HttpSession session){
&nbsp;        Integer uid = getSessionUid(session);
&nbsp;        listservice.removeSong(listId, uid, songId);
&nbsp;        return Map.of(&quot;status&quot;, 200, &quot;message&quot;, &quot;Song removed successfully&quot;, &quot;listId&quot;, listId, &quot;songId&quot;, songId);
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * CREATE (POST) - Adds an album to a user&#39;s list
<b class="nc">&nbsp;     * @param listId id of the target list</b>
&nbsp;     * @param albumId id of the album to add
&nbsp;     * @param body if album is from Spotify
<b class="nc">&nbsp;     * @param session HttpSession containing &quot;uid&quot;</b>
&nbsp;     * @return a Map containing the operation status and confirmation details
<b class="nc">&nbsp;     */</b>
<b class="nc">&nbsp;    @PostMapping(&quot;/{listId}/albums/{albumId}&quot;)</b>
<b class="nc">&nbsp;    public Map&lt;String, Object&gt; addAlbum(@PathVariable Integer listId,</b>
&nbsp;                                        @PathVariable Integer albumId,
<b class="nc">&nbsp;                                        @RequestBody(required = false) Map&lt;String, String&gt; body,</b>
&nbsp;                                        HttpSession session){
&nbsp;        Integer uid = getSessionUid(session);
&nbsp;
<b class="nc">&nbsp;        //if Spotify data provided, create/get track first</b>
<b class="nc">&nbsp;        if(body != null &amp;&amp; body.get(&quot;spotifyData&quot;) != null){</b>
&nbsp;            try {
&nbsp;                JsonNode spotifyJson = objectmapper.readTree(body.get(&quot;spotifyData&quot;));
&nbsp;                Album album = spotifyimportservice.getOrCreateAlbum(spotifyJson);
&nbsp;                albumId = album.getId();
&nbsp;            } catch (JsonProcessingException e){
&nbsp;                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Invalid Spotify data&quot;);
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        listservice.addAlbum(listId, uid, albumId);
&nbsp;        return Map.of(&quot;status&quot;, 200, &quot;message&quot;, &quot;Album added&quot;, &quot;listId&quot;, listId, &quot;albumId&quot;, albumId);
<b class="fc">&nbsp;    }</b>
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;    /**</b>
&nbsp;     * DELETE (DELETE) - Deletes an album from a user&#39;s list
&nbsp;     * @param listId id of the target list
&nbsp;     * @param albumId id of the album to remove
&nbsp;     * @param session HttpSession containing &quot;uid&quot;
&nbsp;     * @return a Map containing the operation status and confirmation details
&nbsp;     */
&nbsp;    @DeleteMapping(&quot;/{listId}/albums/{albumId}&quot;)
&nbsp;    public Map&lt;String, Object&gt; removeAlbum(@PathVariable Integer listId, @PathVariable Integer albumId, HttpSession session){
&nbsp;        Integer uid = getSessionUid(session);
&nbsp;        listservice.removeAlbum(listId, uid, albumId);
<b class="nc">&nbsp;        return Map.of(&quot;status&quot;, 200, &quot;message&quot;, &quot;Album removed successfully&quot;, &quot;listId&quot;, listId, &quot;albumId&quot;, albumId);</b>
&nbsp;    }
<b class="nc">&nbsp;</b>
&nbsp;    /**
&nbsp;     *  LIST (GET) - List all songs in a playlist
&nbsp;     * @param listId id of the target list
&nbsp;     * @param session HttpSession containing &quot;uid&quot;
&nbsp;     * @return the list of songs in a list
&nbsp;     */
&nbsp;    @GetMapping(&quot;/{listId}/tracks&quot;)
&nbsp;    public List&lt;TrackDTO&gt; getSongsInList(@PathVariable Integer listId, HttpSession session){
&nbsp;        Integer uid = getSessionUid(session);
&nbsp;
&nbsp;        return listservice.getSongsForList(listId, uid);
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-12-09 15:12</div>
</div>
</body>
</html>
